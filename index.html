<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReTex SL - Interface Tactique</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, onSnapshot, updateDoc, doc, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAxJS626_23jrcrxwIYAeqxA6UzhH-xlQg",
            authDomain: "parcour-10bbc.firebaseapp.com",
            projectId: "parcour-10bbc",
            storageBucket: "parcour-10bbc.firebasestorage.app",
            messagingSenderId: "372050773120",
            appId: "1:372050773120:web:de15ba05d3e03737961265",
            measurementId: "G-KKLSZF6PFX"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            window.db = db;
            window.auth = auth;
            window.appId = 'retex-master-v1';
            window.fb = { collection, addDoc, getDocs, query, where, orderBy, onSnapshot, updateDoc, doc, limit };
            window.isFirebaseReady = false;

            signInAnonymously(auth).catch((error) => console.warn("Auth Error:", error.code));
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.isFirebaseReady = true;
                    window.dispatchEvent(new Event('firebase-ready'));
                }
            });
        } catch (e) { console.error("Firebase Init Failed:", e); }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .crt-overlay { background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; pointer-events: none; }
        .btn-glitch:active { transform: translateY(2px); }

        /* FOF Logo specific styles */
        .fof-logo-circle { width: 80px; height: 80px; border-radius: 50%; background-color: #0d2847; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border: 2px solid #2a6ecb; box-shadow: 0 0 15px rgba(42, 110, 203, 0.6); transition: all 0.3s ease; }
        .fof-logo-circle.small { width: 48px; height: 48px; border-width: 1px; box-shadow: 0 0 8px rgba(42, 110, 203, 0.4); }
        .fof-logo-circle::before { content: ""; position: absolute; width: 90%; height: 90%; border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.3); box-sizing: border-box; opacity: 0.8; pointer-events: none; }
        .fof-logo-img { width: 75%; height: 75%; object-fit: contain; filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.2)); z-index: 10; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1447173514871443548/aA61xuROKVY4dYquPZ7PT0D35PMG7VVGAWCFTENUSODKhWUP0agxuuHKE3gN6P0D1JJs";
        const AUTHORIZED_MENTORS = ["Papa Yankee", "Tinky Winky", "Snake", "Mirai", "Ry√ºjinn", "YourGalactic"];
        const MENTOR_PASSWORD = "mentor2025";

        // --- Helpers ---
        const timeoutPromise = (promise, ms = 5000) => {
            return new Promise((resolve, reject) => {
                const timer = setTimeout(() => reject(new Error("Timeout DB")), ms);
                promise.then(res => { clearTimeout(timer); resolve(res); }).catch(err => { clearTimeout(timer); reject(err); });
            });
        };

        const saveRequestToDB = async (data) => {
            if (!window.db || !window.isFirebaseReady) return;
            try { await timeoutPromise(window.fb.addDoc(window.fb.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'requests'), { ...data, status: 'pending', timestamp: new Date().toISOString() })); } catch (e) { console.error("DB Error ignored", e); }
        };

        const updateRequestStatus = async (docId, mentorName) => {
            if (!window.db || !window.isFirebaseReady) return;
            try { await window.fb.updateDoc(window.fb.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'requests', docId), { status: 'taken', mentor: mentorName, takenAt: new Date().toISOString() }); } catch (e) { console.error("Update DB Error", e); }
        };

        const saveRetexToDB = async (data) => {
            if (!window.db || !window.isFirebaseReady) return;
            try { await timeoutPromise(window.fb.addDoc(window.fb.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'retex'), { ...data, timestamp: new Date().toISOString() })); } catch (e) { console.error("DB Save Retex Error", e); }
        };

        const sendToDiscord = async (data, callback) => {
            try {
                const payload = data.content ? data : { embeds: [data] };
                const response = await fetch(DISCORD_WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) callback('success'); else callback('error');
            } catch (error) { callback('error'); }
        };

        // --- Icons ---
        const IconBase = ({ size = 20, className = "", children }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Check = (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const X = (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><polyline points="9 18 15 12 9 6"/></IconBase>;
        const ChevronLeft = (p) => <IconBase {...p}><polyline points="15 18 9 12 15 6"/></IconBase>;
        const Shield = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const Target = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>;
        const Radio = (p) => <IconBase {...p}><circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"/></IconBase>;
        const Activity = (p) => <IconBase {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>;
        const Users = (p) => <IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const UserPlus = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></IconBase>;
        const Send = (p) => <IconBase {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconBase>;
        const Loader = (p) => <IconBase {...p} className={`animate-spin ${p.className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const Lock = (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconBase>;
        const Unlock = (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></IconBase>;
        const History = (p) => <IconBase {...p}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></IconBase>;
        const Inbox = (p) => <IconBase {...p}><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></IconBase>;
        const WifiOff = (p) => <IconBase {...p}><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></IconBase>;
        const Calendar = (p) => <IconBase {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></IconBase>;
        const Edit = (p) => <IconBase {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></IconBase>;
        const FileText = (p) => <IconBase {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></IconBase>;
        const Clipboard = (p) => <IconBase {...p}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /></IconBase>;
        const CheckSquare = (p) => <IconBase {...p}><polyline points="9 11 12 14 22 4" /><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" /></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></IconBase>;
        const Eye = (p) => <IconBase {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" /></IconBase>;

        // --- Data ---
        const EVAL_OPTIONS = [
            { id: 'na', label: 'NON ACQUIS', short: 'NON', color: 'bg-red-900/50 border-red-500 text-red-200' },
            { id: 'ec', label: 'EN COURS', short: 'EN COURS', color: 'bg-amber-900/50 border-amber-500 text-amber-200' },
            { id: 'ac', label: 'ACQUIS', short: 'ACQUIS', color: 'bg-emerald-900/50 border-emerald-500 text-emerald-200' },
            { id: 'no', label: 'NON OBS.', short: 'N.O.', color: 'bg-slate-700/50 border-slate-500 text-slate-300' },
        ];

        const CATEGORIES = [
            { id: 'cat_cmd', title: 'COMMANDEMENT', icon: Users, items: [{ id: 'posture', label: 'Posture' }, { id: 'comms', label: 'Communication' }, { id: 'stress', label: 'Humain & Stress' }] },
            { id: 'cat_tac', title: 'TACTIQUE', icon: Target, items: [{ id: 'analyse', label: 'Analyse Terrain' }, { id: 'decision', label: 'Prise D√©cision' }, { id: 'coord', label: 'Coordination' }] },
            { id: 'cat_e2', title: '√âCHELON 2', icon: Shield, items: [{ id: 'pedago', label: 'P√©dagogie' }, { id: 'vision', label: 'Vision Globale' }] }
        ];

        // --- Components ---
        const Logo = ({ small = false }) => (
            <div className={`fof-logo-circle ${small ? 'small' : ''}`}>
                <img src="Logo.png" alt="FOF" className="fof-logo-img" onError={(e) => { e.target.style.display = 'none'; e.target.parentNode.style.backgroundColor = '#0d2847'; }}/>
            </div>
        );

        const InputField = ({ label, value, onChange, placeholder, type = "text", readOnly = false }) => (
            <div className="w-full"><label className="text-xs font-mono text-slate-400 uppercase tracking-wide block mb-1">{label}</label><input type={type} value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder} readOnly={readOnly} className={`bg-slate-800/80 border border-slate-700 rounded p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none w-full text-white ${readOnly ? 'opacity-70 cursor-not-allowed border-dashed' : ''}`} /></div>
        );

        const TextArea = ({ label, value, onChange, placeholder, height = "h-24" }) => (
            <div className="w-full"><label className="text-xs font-mono text-slate-400 uppercase tracking-wide block mb-1">{label}</label><textarea value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder} className={`bg-slate-800/80 border border-slate-700 rounded p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none resize-none w-full ${height}`} /></div>
        );

        // --- DISCORD STYLE PREVIEW ---
        const PreviewCard = ({ title, color, fields, footer, onClose }) => {
            const borderColors = {
                'green': 'border-l-emerald-500', 'blue': 'border-l-indigo-500', 'amber': 'border-l-amber-500', 'red': 'border-l-red-500', 'indigo': 'border-l-indigo-500'
            };
            const col = borderColors[color] || 'border-l-slate-500';

            return (
                <div className={`bg-[#2b2d31] rounded-r-md border-l-[4px] ${col} p-4 shadow-xl w-full max-w-full overflow-hidden relative`}>
                    {onClose && <button onClick={onClose} className="absolute top-2 right-2 text-slate-400 hover:text-white"><X size={20}/></button>}
                    <div className="font-bold text-base text-white mb-4 flex items-center">{title}</div>
                    <div className="space-y-3">
                        {fields.map((field, idx) => (
                            <div key={idx} className={`${field.inline ? 'inline-block w-1/2 align-top pr-2 mb-2' : 'block mb-2'}`}>
                                <div className="text-xs font-bold text-[#b5bac1] uppercase mb-0.5">{field.name}</div>
                                <div className="text-sm text-[#dbdee1] whitespace-pre-wrap leading-snug">{field.value}</div>
                            </div>
                        ))}
                    </div>
                    {footer && <div className="mt-4 pt-2 border-t border-[#3f4147] text-[10px] text-[#949ba4]">{footer}</div>}
                </div>
            );
        };

        // --- MENTOR LOGIN ---
        const MentorLogin = ({ onLogin }) => {
            const [pseudo, setPseudo] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [shake, setShake] = useState(false);

            const handleLogin = (e) => {
                e.preventDefault();
                setError('');
                if (password !== MENTOR_PASSWORD) {
                    setError('Code d\'acc√®s erron√©.');
                    setShake(true); setTimeout(() => setShake(false), 300);
                    return;
                }
                const foundMentor = AUTHORIZED_MENTORS.find(m => m.toLowerCase() === pseudo.trim().toLowerCase());
                if (foundMentor) {
                    onLogin(foundMentor);
                } else {
                    setError('Identifiant non reconnu.');
                    setShake(true); setTimeout(() => setShake(false), 300);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center h-full animate-in fade-in duration-500">
                    <div className="w-full max-w-sm bg-slate-800/50 p-8 rounded-xl border border-indigo-500/30 shadow-2xl relative">
                        <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center border-4 border-indigo-500 shadow-lg"><Lock size={32} className="text-indigo-400" /></div>
                        <h2 className="text-center text-xl font-bold text-white mt-8 mb-6 tracking-wider">ACC√àS MENTOR</h2>
                        <form onSubmit={handleLogin} className={`space-y-5 ${shake ? 'animate-bounce' : ''}`}>
                            <InputField label="IDENTIFIANT" placeholder="Votre pseudo..." value={pseudo} onChange={setPseudo} />
                            <InputField label="CODE D'ACC√àS" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={password} onChange={setPassword} />
                            {error && <div className="text-red-400 text-xs text-center font-mono bg-red-900/20 py-2 rounded border border-red-500/30 flex items-center justify-center space-x-2"><X size={14} /><span>{error}</span></div>}
                            <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded transition-all shadow-lg flex items-center justify-center space-x-2 mt-4"><span>INITIALISER</span><Unlock size={18} /></button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- STUDENT ---
        const StudentInterface = ({ onBack }) => {
            const [step, setStep] = useState(0);
            const [data, setData] = useState({ name: '', target: 'SL1', objectives: '', availability: '' });
            const [isSending, setIsSending] = useState(false);

            const buildEmbed = () => ({
                title: `üõ°Ô∏è DEMANDE DE SUIVI : ${data.name.toUpperCase()}`,
                color: 3447003, // Blue
                fields: [
                    { name: "üéØ NIVEAU VIS√â", value: data.target, inline: false },
                    { name: "üìÖ DISPONIBILIT√âS", value: data.availability || "√Ä d√©finir", inline: false },
                    { name: "üìù AXES DE TRAVAIL", value: data.objectives || "Non sp√©cifi√©", inline: false }
                ],
                footer: { text: "FOF - Module Formation" }
            });

            const handleSend = async () => {
                setIsSending(true);
                await saveRequestToDB(data);
                await sendToDiscord(buildEmbed(), () => {});
                setIsSending(false);
                setStep(1);
            };

            return (
                <div className="animate-in fade-in h-full flex flex-col">
                    <header className="mb-4 border-b border-indigo-500/30 pb-3 flex justify-between"><div className="flex items-center"><UserPlus size={20} className="mr-2 text-indigo-400"/><h2 className="font-bold">DEMANDE</h2></div><Logo small={true}/></header>
                    {step === 0 ? (
                        <div className="space-y-4 flex-1 overflow-y-auto">
                            <InputField label="Identit√©" placeholder="Ex: Recrue Joker" value={data.name} onChange={v => setData({...data, name: v})} />
                            <div className="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <label className="text-xs text-slate-400 block mb-2">Niveau Vis√©</label>
                                <div className="flex space-x-2">{['SL1', 'SL2'].map(lvl => <button key={lvl} onClick={() => setData({...data, target: lvl})} className={`flex-1 py-2 rounded font-bold text-sm ${data.target === lvl ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-400'}`}>{lvl}</button>)}</div>
                            </div>
                            <TextArea label="Objectifs / Besoins" value={data.objectives} onChange={v => setData({...data, objectives: v})} height="h-20" />
                            <TextArea label="Disponibilit√©s" value={data.availability} onChange={v => setData({...data, availability: v})} height="h-20" />
                            <button onClick={handleSend} disabled={isSending} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded font-bold shadow-lg flex justify-center items-center">{isSending ? <Loader/> : <span>ENVOYER LA DEMANDE</span>}</button>
                        </div>
                    ) : (
                        <div className="flex flex-col items-center justify-center flex-1 space-y-4">
                            <div className="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center text-emerald-500"><Check size={32} /></div>
                            <h3 className="text-xl font-bold">DEMANDE TRANSMISE</h3>
                            <button onClick={() => {setData({ name: '', target: 'SL1', objectives: '', availability: '' }); setStep(0);}} className="text-sm text-indigo-400 underline">Nouvelle demande</button>
                        </div>
                    )}
                </div>
            );
        };

        // --- STUDENT HISTORY ---
        const StudentHistory = ({ studentName, onBack, onNewRetex }) => {
            const [history, setHistory] = useState([]);
            const [selectedSession, setSelectedSession] = useState(null);

            useEffect(() => {
                if (!window.db) return;
                const q = window.fb.query(window.fb.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'retex'), window.fb.where('menteeName', '==', studentName));
                window.fb.getDocs(q).then(snap => {
                    const docs = snap.docs.map(d => d.data());
                    docs.sort((a,b) => new Date(b.missionDate) - new Date(a.missionDate));
                    setHistory(docs);
                });
            }, [studentName]);

            const getEvalShort = (id) => EVAL_OPTIONS.find(o => o.id === id)?.short || 'N/A';

            const renderSessionModal = () => {
                if(!selectedSession) return null;
                
                // Reconstruct Fields for PreviewCard based on saved data
                const s = selectedSession;
                let color = 'blue';
                if(s.nextStep.includes('Validation')) color = 'green';
                if(s.nextStep.includes('Difficult√©')) color = 'red';

                const fields = [
                    { name: "üìã INFO MISSION", value: `**Date:** ${s.missionDate}\n**Type:** ${s.missionType}`, inline: true },
                    { name: "üë§ ACTEURS", value: `**Mentor:** ${s.mentorName}\n**√âl√®ve:** ${s.menteeName} (${s.echelon})`, inline: true },
                    { name: "-------------------------------------------", value: "**√âVALUATION COMP√âTENCES**", inline: false },
                    { name: "üëÆ COMMANDEMENT", value: CATEGORIES[0].items.map(i => `**${i.label}:** ${getEvalShort(s[i.id])}`).join('\n'), inline: true },
                    { name: "üéØ TACTIQUE", value: CATEGORIES[1].items.map(i => `**${i.label}:** ${getEvalShort(s[i.id])}`).join('\n'), inline: true },
                ];
                if(s.echelon === 'SL2') {
                    fields.push({ name: "üõ°Ô∏è √âCHELON 2", value: CATEGORIES[2].items.map(i => `**${i.label}:** ${getEvalShort(s[i.id])}`).join('\n'), inline: true });
                }
                fields.push(
                    { name: "-------------------------------------------", value: "**ANALYSE**", inline: false },
                    { name: "‚úÖ POINTS FORTS (KEEP)", value: s.keep || "RAS", inline: false },
                    { name: "‚ö†Ô∏è √Ä TRAVAILLER (FIX)", value: s.drop || "RAS", inline: false },
                    { name: "üîÆ SUIVI", value: `**Prochain Obj:** ${s.objective}\n**Avis:** ${s.nextStep}`, inline: false }
                );

                return (
                    <div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-in fade-in">
                        <div className="w-full max-w-lg max-h-full overflow-y-auto">
                            <PreviewCard 
                                title={`üìÑ RETEX MISSION : ${s.menteeName.toUpperCase()}`} 
                                color={color} 
                                fields={fields} 
                                footer="FOF - Force Op√©rationnelle Fran√ßaise"
                                onClose={() => setSelectedSession(null)}
                            />
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col relative">
                    {renderSessionModal()}
                    <header className="mb-4 border-b border-indigo-500/30 pb-3 flex items-center space-x-3">
                        <button onClick={onBack} className="text-slate-400 hover:text-white"><ChevronLeft size={20}/></button>
                        <div className="flex-1"><h2 className="text-lg font-bold">DOSSIER √âL√àVE</h2><p className="text-xs text-indigo-400 font-mono">{studentName}</p></div>
                        <button onClick={onNewRetex} className="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center space-x-1 shadow"><Shield size={14}/><span>NOUVEAU</span></button>
                    </header>
                    <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                        {history.length === 0 ? <div className="text-center text-slate-500 mt-10">Aucun historique.</div> : history.map((s, idx) => (
                            <div key={idx} onClick={() => setSelectedSession(s)} className="bg-slate-800 border border-slate-700 p-3 rounded cursor-pointer hover:bg-slate-700 transition-colors flex justify-between items-center group">
                                <div>
                                    <div className="text-xs text-slate-400 font-mono mb-1">{s.missionDate} | {s.missionType}</div>
                                    <div className="text-sm font-bold text-slate-200 group-hover:text-white">Mentor: {s.mentorName}</div>
                                </div>
                                <div className="flex items-center space-x-3">
                                    <div className={`text-[10px] font-bold px-2 py-1 rounded border ${s.nextStep.includes('Validation') ? 'border-emerald-500 text-emerald-400' : 'border-indigo-500 text-indigo-400'}`}>{s.nextStep.split(' ')[0]}</div>
                                    <Eye size={16} className="text-slate-500 group-hover:text-white"/>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- MENTOR RETEX ---
        const MentorInterface = ({ onBack, mentorName, preselectedStudent }) => {
            const [step, setStep] = useState(0);
            const [data, setData] = useState({
                missionDate: new Date().toISOString().split('T')[0], mentorName: mentorName, menteeName: preselectedStudent || '', missionType: 'Entrainement', echelon: 'SL1',
                posture: 'no', comms: 'no', stress: 'no', analyse: 'no', decision: 'no', coord: 'no', pedago: 'no', vision: 'no',
                keep: '', drop: '', objective: '', nextStep: ''
            });

            const getEvalShort = (id) => EVAL_OPTIONS.find(o => o.id === id)?.short || 'N/A';

            const buildEmbed = () => {
                let color = 10181046; // Grey
                if (data.nextStep.includes('Validation')) color = 5763719; // Green
                else if (data.nextStep.includes('Difficult√©')) color = 15548997; // Red
                else if (data.nextStep.includes('Conforme')) color = 3447003; // Blue

                // Icons added to field names as per user request
                const fields = [
                    { name: "üìã INFO MISSION", value: `**Date:** ${data.missionDate}\n**Type:** ${data.missionType}`, inline: true },
                    { name: "üë§ ACTEURS", value: `**Mentor:** ${data.mentorName}\n**√âl√®ve:** ${data.menteeName} (${data.echelon})`, inline: true },
                    { name: "-------------------------------------------", value: "**√âVALUATION COMP√âTENCES**", inline: false },
                    { name: "üëÆ COMMANDEMENT", value: CATEGORIES[0].items.map(i => `**${i.label}:** ${getEvalShort(data[i.id])}`).join('\n'), inline: true },
                    { name: "üéØ TACTIQUE", value: CATEGORIES[1].items.map(i => `**${i.label}:** ${getEvalShort(data[i.id])}`).join('\n'), inline: true },
                ];
                if(data.echelon === 'SL2') {
                    fields.push({ name: "üõ°Ô∏è √âCHELON 2", value: CATEGORIES[2].items.map(i => `**${i.label}:** ${getEvalShort(data[i.id])}`).join('\n'), inline: true });
                }
                fields.push(
                    { name: "-------------------------------------------", value: "**ANALYSE**", inline: false },
                    { name: "‚úÖ POINTS FORTS (KEEP)", value: data.keep || "RAS", inline: false },
                    { name: "‚ö†Ô∏è √Ä TRAVAILLER (FIX)", value: data.drop || "RAS", inline: false },
                    { name: "üîÆ SUIVI", value: `**Prochain Obj:** ${data.objective}\n**Avis:** ${data.nextStep}`, inline: false }
                );

                return { title: `üìÑ RETEX MISSION : ${data.menteeName.toUpperCase()}`, color: color, fields: fields, footer: { text: "FOF - Force Op√©rationnelle Fran√ßaise" } };
            };

            const handleSend = async () => {
                await saveRetexToDB(data);
                await sendToDiscord(buildEmbed(), () => {});
                onBack();
            };

            const EvalGrid = () => (
                <div className="space-y-4">
                    {CATEGORIES.map(cat => {
                        if(cat.id === 'cat_e2' && data.echelon !== 'SL2') return null;
                        return (
                            <div key={cat.id} className="bg-slate-800/30 p-3 rounded border border-slate-700">
                                <div className="flex items-center text-indigo-400 mb-2 border-b border-slate-700 pb-1"><cat.icon size={16} className="mr-2"/><span className="font-bold text-xs">{cat.title}</span></div>
                                <div className="space-y-3">{cat.items.map(item => (
                                    <div key={item.id}>
                                        <div className="text-xs text-slate-300 mb-1">{item.label}</div>
                                        <div className="grid grid-cols-4 gap-1">
                                            {EVAL_OPTIONS.map(opt => (
                                                <button key={opt.id} onClick={() => setData({...data, [item.id]: opt.id})} className={`p-1 text-[9px] font-bold rounded border ${data[item.id] === opt.id ? `${opt.color} shadow` : 'bg-slate-800 border-slate-700 text-slate-500'}`}>{opt.short}</button>
                                            ))}
                                        </div>
                                    </div>
                                ))}</div>
                            </div>
                        )
                    })}
                </div>
            );

            return (
                <div className="h-full flex flex-col">
                    <header className="mb-4 border-b border-indigo-500/30 pb-3"><h2 className="font-bold flex items-center"><Shield size={20} className="mr-2 text-indigo-400"/>NOUVEAU RETEX</h2></header>
                    <div className="flex-1 overflow-y-auto space-y-6 pr-2">
                        {step === 0 && <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-3"><InputField label="Date" type="date" value={data.missionDate} onChange={v => setData({...data, missionDate: v})} /><div className="w-full"><label className="text-xs font-mono text-slate-400 uppercase tracking-wide block mb-1">Type</label><select value={data.missionType} onChange={e => setData({...data, missionType: e.target.value})} className="bg-slate-800/80 border border-slate-700 rounded p-3 text-sm w-full text-white"><option>Entrainement</option><option>Op√©ration R√©elle</option><option>Certification</option></select></div></div>
                            <InputField label="√âl√®ve" value={data.menteeName} onChange={v => setData({...data, menteeName: v})} />
                            <div className="bg-slate-800/50 p-3 rounded border border-slate-700"><label className="text-xs text-slate-400 mb-2 block">Niveau</label><div className="flex space-x-2">{['SL1', 'SL2'].map(lvl => <button key={lvl} onClick={() => setData({...data, echelon: lvl})} className={`flex-1 py-2 rounded font-bold text-xs ${data.echelon === lvl ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-400'}`}>{lvl}</button>)}</div></div>
                        </div>}
                        {step === 1 && <EvalGrid />}
                        {step === 2 && <div className="space-y-4">
                            <div className="border-l-4 border-emerald-500 pl-3 bg-emerald-900/10 p-2 rounded-r"><h4 className="text-emerald-400 text-xs font-bold mb-1">KEEP</h4><TextArea value={data.keep} onChange={v => setData({...data, keep: v})} height="h-20" /></div>
                            <div className="border-l-4 border-amber-500 pl-3 bg-amber-900/10 p-2 rounded-r"><h4 className="text-amber-400 text-xs font-bold mb-1">FIX</h4><TextArea value={data.drop} onChange={v => setData({...data, drop: v})} height="h-20" /></div>
                            <InputField label="Prochain Objectif" value={data.objective} onChange={v => setData({...data, objective: v})} />
                            <div className="w-full"><label className="text-xs font-mono text-slate-400 uppercase tracking-wide block mb-1">Avis</label><select value={data.nextStep} onChange={e => setData({...data, nextStep: e.target.value})} className="bg-slate-800/80 border border-slate-700 rounded p-3 text-sm w-full text-white"><option value="">-- Choisir --</option><option>Progression Conforme</option><option>Progression Lente</option><option>En Difficult√©</option><option>Pr√™t pour Validation</option></select></div>
                        </div>}
                        {step === 3 && <div className="space-y-4">
                            <div className="text-center text-xs text-slate-400">PR√âVISUALISATION</div>
                            <PreviewCard title={`üìÑ RETEX : ${data.menteeName.toUpperCase()}`} color={data.nextStep.includes('Validation') ? 'green' : data.nextStep.includes('Conforme') ? 'blue' : 'red'} fields={buildEmbed().fields} footer="FOF - Force Op√©rationnelle Fran√ßaise" />
                            <button onClick={handleSend} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded font-bold shadow-lg flex justify-center items-center space-x-2"><Send size={18}/><span>TRANSMETTRE</span></button>
                        </div>}
                    </div>
                    <div className="flex justify-between mt-4 pt-3 border-t border-slate-800">
                        <button onClick={() => setStep(Math.max(0, step - 1))} disabled={step===0} className="text-xs text-slate-500 hover:text-white px-3 py-2">RETOUR</button>
                        {step < 3 && <button onClick={() => setStep(Math.min(3, step + 1))} className="bg-slate-100 text-slate-900 text-xs font-bold px-4 py-2 rounded hover:bg-white">SUIVANT</button>}
                    </div>
                </div>
            );
        };

        // --- DASHBOARD ---
        const MentorDashboard = ({ mentorName, onNavigate, onStartSession }) => {
            const [requests, setRequests] = useState([]);
            const [myStudents, setMyStudents] = useState([]);

            useEffect(() => {
                if (!window.db) return;
                
                // Pending requests
                const q1 = window.fb.query(window.fb.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'requests'), window.fb.where('status', '==', 'pending'));
                const u1 = window.fb.onSnapshot(q1, snap => setRequests(snap.docs.map(d => ({id: d.id, ...d.data()}))));

                // My Accepted requests (Students I took charge of)
                const q2 = window.fb.query(window.fb.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'requests'), window.fb.where('mentor', '==', mentorName), window.fb.where('status', '==', 'taken'));
                const u2 = window.fb.onSnapshot(q2, snap => {
                    const taken = snap.docs.map(d => ({ name: d.data().name, level: d.data().target }));
                    // Fetch existing retex history to build complete student list
                    // (Simplification: we assume 'taken' requests + manual retex entries = my students)
                    // For now, let's just use the taken requests as the base for "My Students" to keep it synced with the "Accepter" action
                    setMyStudents(taken);
                });

                return () => { u1(); u2(); };
            }, [mentorName]);

            const acceptRequest = async (req) => {
                await updateRequestStatus(req.id, mentorName);
                await sendToDiscord({
                    content: `üì¢ **@${req.name}, ton dossier a √©t√© pris en charge !**`,
                    embeds: [{
                        title: "‚úÖ FORMATION VALID√âE",
                        color: 5763719,
                        fields: [
                            { name: "Mentor", value: mentorName, inline: true },
                            { name: "√âl√®ve", value: req.name, inline: true },
                            { name: "Objectif", value: req.target || "N/A", inline: true }
                        ],
                        footer: { text: "FOF - Force Op√©rationnelle Fran√ßaise" }
                    }]
                }, () => {});
            };

            return (
                <div className="h-full flex flex-col animate-in fade-in">
                    <header className="mb-6 border-b border-indigo-500/30 pb-3 flex justify-between items-center"><div><h2 className="text-xl font-bold flex items-center text-indigo-400"><Shield size={24} className="mr-2"/>QG MENTOR</h2><p className="text-xs text-slate-500 font-mono">{mentorName}</p></div><Logo small={true}/></header>
                    <div className="flex-1 overflow-y-auto space-y-8 pr-2">
                        <div>
                            <h3 className="text-sm font-bold text-white mb-2 flex items-center"><Inbox size={16} className="mr-2 text-emerald-400"/> DEMANDES ({requests.length})</h3>
                            {requests.length === 0 ? <div className="text-xs text-slate-500 italic p-2 border border-dashed border-slate-700 rounded">Aucune demande.</div> : 
                                <div className="space-y-2">{requests.map(r => (
                                    <div key={r.id} className="bg-slate-800 p-3 rounded border-l-4 border-emerald-500 flex justify-between items-center shadow">
                                        <div><div className="font-bold text-sm text-white">{r.name} <span className="ml-2 text-[10px] bg-slate-700 px-1 rounded text-indigo-300">{r.target}</span></div><div className="text-[10px] text-slate-400 mt-1">{r.objectives}</div></div>
                                        <button onClick={() => acceptRequest(r)} className="bg-emerald-600 hover:bg-emerald-500 p-2 rounded text-white shadow"><Check size={16}/></button>
                                    </div>
                                ))}</div>}
                        </div>
                        <button onClick={() => onStartSession('')} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white p-3 rounded font-bold shadow-lg flex justify-center items-center space-x-2"><Shield size={18}/><span>NOUVEAU RETEX (LIBRE)</span></button>
                        <div>
                            <h3 className="text-sm font-bold text-white mb-2 flex items-center"><History size={16} className="mr-2 text-amber-400"/> SUIVI √âL√àVES</h3>
                            <div className="grid grid-cols-1 gap-2">
                                {myStudents.map((stu, i) => (
                                    <div key={i} onClick={() => onNavigate('history', stu.name)} className="bg-slate-800 p-3 rounded border border-slate-700 cursor-pointer hover:bg-slate-700 flex justify-between items-center">
                                        <span className="font-bold text-sm text-slate-200">{stu.name}</span>
                                        <span className="text-[10px] text-slate-500 font-mono">{stu.level}</span>
                                    </div>
                                ))}
                                {myStudents.length === 0 && <div className="text-xs text-slate-500 text-center">Aucun √©l√®ve suivi.</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN MENU ---
        const MainMenu = ({ onSelect }) => (
            <div className="flex flex-col items-center justify-center space-y-6 h-full py-10 animate-in zoom-in-95 duration-500">
                <div className="text-center mb-6">
                    <div className="mx-auto mb-6 transform hover:scale-110 transition-transform duration-500">
                        <Logo />
                    </div>
                    
                    <h1 className="text-3xl md:text-4xl font-black tracking-widest text-white uppercase drop-shadow-[0_0_10px_rgba(255,255,255,0.2)]">
                        FOF <span className="text-indigo-500">MASTER</span>
                    </h1>
                    <div className="h-1 w-24 bg-indigo-600 mx-auto my-3 rounded-full"></div>
                    <p className="text-xs text-slate-400 font-mono tracking-widest">INTERFACE DE GESTION OP√âRATIONNELLE</p>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl px-4">
                    <button onClick={() => onSelect('student')} className="group bg-slate-800 hover:bg-slate-750 border border-slate-700 hover:border-emerald-500/50 p-6 rounded-xl transition-all duration-300 flex flex-col items-center justify-center shadow-lg hover:shadow-emerald-900/20 btn-glitch relative overflow-hidden">
                         <div className="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="p-4 bg-emerald-900/30 rounded-full text-emerald-400 group-hover:text-emerald-300 group-hover:scale-110 transition-all mb-4">
                            <UserPlus size={32} />
                        </div>
                        <h3 className="text-lg font-bold text-slate-200 group-hover:text-white mb-1">STAGIAIRE</h3>
                        <p className="text-[10px] text-slate-500 font-mono text-center">Initialiser une demande de suivi</p>
                    </button>

                    <button onClick={() => onSelect('mentor_login')} className="group bg-slate-800 hover:bg-slate-750 border border-slate-700 hover:border-indigo-500/50 p-6 rounded-xl transition-all duration-300 flex flex-col items-center justify-center shadow-lg hover:shadow-indigo-900/20 btn-glitch relative overflow-hidden">
                         <div className="absolute inset-0 bg-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="p-4 bg-indigo-900/30 rounded-full text-indigo-400 group-hover:text-indigo-300 group-hover:scale-110 transition-all mb-4">
                            <Shield size={32} />
                        </div>
                        <h3 className="text-lg font-bold text-slate-200 group-hover:text-white mb-1">MENTOR</h3>
                        <p className="text-[10px] text-slate-500 font-mono text-center">R√©diger un compte-rendu</p>
                    </button>
                </div>
            </div>
        );

        const App = () => {
            const [view, setView] = useState('menu');
            const [user, setUser] = useState(null);
            const [student, setStudent] = useState(null);

            useEffect(() => {
                const listener = () => {}; 
                window.addEventListener('firebase-ready', listener);
                return () => window.removeEventListener('firebase-ready', listener);
            }, []);

            return (
                <div className="min-h-screen p-2 md:p-8 flex justify-center items-center md:items-start bg-[#0f172a]">
                    <div className="w-full max-w-3xl bg-[#1e232b] border border-slate-700/50 shadow-2xl rounded-2xl overflow-hidden relative flex flex-col h-[95vh] md:h-[700px]">
                        <div className="bg-[#151921] px-4 py-3 border-b border-slate-800 flex justify-between items-center shrink-0">
                            {view !== 'menu' && <button onClick={() => setView(view.includes('dashboard') ? 'menu' : 'mentor_dashboard')} className="text-xs font-bold text-slate-400 hover:text-white flex items-center"><ChevronLeft size={12} className="mr-1"/>RETOUR</button>}
                            <div className="flex items-center space-x-2"><div className="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></div><span className="text-[10px] font-mono text-slate-500">FOF-NET</span></div>
                        </div>
                        <div className="p-4 md:p-6 relative flex-1 overflow-hidden">
                            {view === 'menu' && <MainMenu onSelect={setView} />}
                            {view === 'student' && <StudentInterface onBack={() => setView('menu')} />}
                            {view === 'mentor_login' && <MentorLogin onLogin={(name) => { setUser(name); setView('mentor_dashboard'); }} />}
                            {view === 'mentor_dashboard' && <MentorDashboard mentorName={user} onNavigate={(v, data) => { setStudent(data); setView(v); }} onStartSession={(stu) => { setStudent(stu); setView('retex'); }} />}
                            {view === 'retex' && <MentorInterface mentorName={user} preselectedStudent={student} onBack={() => setView('mentor_dashboard')} />}
                            {view === 'history' && <StudentHistory studentName={student} onBack={() => setView('mentor_dashboard')} onNewRetex={() => setView('retex')} />}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
